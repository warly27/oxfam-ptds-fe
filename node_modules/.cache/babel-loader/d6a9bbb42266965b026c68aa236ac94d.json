{"ast":null,"code":"import _regeneratorRuntime from\"/Users/wdelacruz/project_2021/matx-react/node_modules/@babel/runtime/helpers/esm/regeneratorRuntime.js\";import _asyncToGenerator from\"/Users/wdelacruz/project_2021/matx-react/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";import _slicedToArray from\"/Users/wdelacruz/project_2021/matx-react/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";import _objectSpread from\"/Users/wdelacruz/project_2021/matx-react/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import React,{createContext,useEffect,useReducer}from'react';import jwtDecode from'jwt-decode';import axios from'axios.js';import{MatxLoading}from'app/components';import{jsx as _jsx}from\"react/jsx-runtime\";var initialState={isAuthenticated:false,isInitialised:false,user:null};var isValidToken=function isValidToken(accessToken){if(!accessToken){return false;}var decodedToken=jwtDecode(accessToken);var currentTime=Date.now()/1000;return decodedToken.exp>currentTime;};var setSession=function setSession(accessToken){if(accessToken){localStorage.setItem('accessToken',accessToken);axios.defaults.headers.common.Authorization=\"Bearer \".concat(accessToken);}else{localStorage.removeItem('accessToken');delete axios.defaults.headers.common.Authorization;}};var reducer=function reducer(state,action){switch(action.type){case'INIT':{var _action$payload=action.payload,isAuthenticated=_action$payload.isAuthenticated,user=_action$payload.user;return _objectSpread(_objectSpread({},state),{},{isAuthenticated:isAuthenticated,isInitialised:true,user:user});}case'LOGIN':{var _user=action.payload.user;return _objectSpread(_objectSpread({},state),{},{isAuthenticated:true,user:_user});}case'LOGOUT':{return _objectSpread(_objectSpread({},state),{},{isAuthenticated:false,user:null});}case'REGISTER':{var _user2=action.payload.user;return _objectSpread(_objectSpread({},state),{},{isAuthenticated:true,user:_user2});}default:{return _objectSpread({},state);}}};var AuthContext=/*#__PURE__*/createContext(_objectSpread(_objectSpread({},initialState),{},{method:'JWT',login:function login(){return Promise.resolve();},logout:function logout(){},register:function register(){return Promise.resolve();}}));export var AuthProvider=function AuthProvider(_ref){var children=_ref.children;var _useReducer=useReducer(reducer,initialState),_useReducer2=_slicedToArray(_useReducer,2),state=_useReducer2[0],dispatch=_useReducer2[1];var login=/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee(email,password){var response,_response$data,accessToken,user;return _regeneratorRuntime().wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.next=2;return axios.post('/api/auth/login',{email:email,password:password});case 2:response=_context.sent;_response$data=response.data,accessToken=_response$data.accessToken,user=_response$data.user;setSession(accessToken);dispatch({type:'LOGIN',payload:{user:user}});case 6:case\"end\":return _context.stop();}}},_callee);}));return function login(_x,_x2){return _ref2.apply(this,arguments);};}();var register=/*#__PURE__*/function(){var _ref3=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee2(email,username,password){var response,_response$data2,accessToken,user;return _regeneratorRuntime().wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.next=2;return axios.post('/api/auth/register',{email:email,username:username,password:password});case 2:response=_context2.sent;_response$data2=response.data,accessToken=_response$data2.accessToken,user=_response$data2.user;setSession(accessToken);dispatch({type:'REGISTER',payload:{user:user}});case 6:case\"end\":return _context2.stop();}}},_callee2);}));return function register(_x3,_x4,_x5){return _ref3.apply(this,arguments);};}();var logout=function logout(){setSession(null);dispatch({type:'LOGOUT'});};useEffect(function(){;_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee3(){var accessToken,response,user;return _regeneratorRuntime().wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:_context3.prev=0;accessToken=window.localStorage.getItem('accessToken');if(!(accessToken&&isValidToken(accessToken))){_context3.next=11;break;}setSession(accessToken);_context3.next=6;return axios.get('/api/auth/profile');case 6:response=_context3.sent;user=response.data.user;dispatch({type:'INIT',payload:{isAuthenticated:true,user:user}});_context3.next=12;break;case 11:dispatch({type:'INIT',payload:{isAuthenticated:false,user:null}});case 12:_context3.next=18;break;case 14:_context3.prev=14;_context3.t0=_context3[\"catch\"](0);console.error(_context3.t0);dispatch({type:'INIT',payload:{isAuthenticated:false,user:null}});case 18:case\"end\":return _context3.stop();}}},_callee3,null,[[0,14]]);}))();},[]);if(!state.isInitialised){return/*#__PURE__*/_jsx(MatxLoading,{});}return/*#__PURE__*/_jsx(AuthContext.Provider,{value:_objectSpread(_objectSpread({},state),{},{method:'JWT',login:login,logout:logout,register:register}),children:children});};export default AuthContext;","map":null,"metadata":{},"sourceType":"module"}